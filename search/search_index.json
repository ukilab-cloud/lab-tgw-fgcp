{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"Welcome to the Fortinet FGCP Active-Passive HA in AWS Lab Guide","text":"<p>This is an interactive lab aimed at learning how to deploy and do post deployment basic configuration. The lab will provide some exercises that are challenges and not step-by-step sequences. Ideally work together and solve the challenges. </p> <p>Warning</p> <p>This lab guide does not provide solutions. Only challenges with hints and tips and is designed to be used in an interactive session.</p> <p>This guide assumes basic Linux skills and competency with command line editors. Neovim (nvim) and Micro are included as well as Vi</p> <p>There are 2 modes to deploy the lab.</p> <ol> <li> <p>With a Jumphost with all the tools necessary for deployment and access to the resources</p> <ul> <li>The Jumphost</li> </ul> </li> <li> <p>Without a Jumphost and directly deploying the environment and then working through the exercises from anywhere. </p> </li> </ol> <p>The assumption is that this lab will be deployed by the Jumphost. The Jumphost has already been deployed for you, however if it you are doing this lab unattended then please deploy the following template AWS Jumphost Template if you intend to use the exact environment.</p> <p>No changes are required in AWS all exercises are preformed on the FortiGate, Ubuntu hosts and Jumpbox exclusively.</p> <p>Once you are ready proceed to Environment Overview</p> <p>Note</p> <p>Only internet access, a browser and an SSH client will be required for this lab.</p>"},{"location":"deployment/","title":"Deployment Guide","text":"<ul> <li>Log in to AWS Console - Use credentials provided by the instructor</li> <li>SSH to Jumpbox </li> <li>Clone the repository with:  <pre><code>git clone https://github.com/ukilab-cloud/lab-tgw-fgcp\n</code></pre></li> <li>Prepare for deployment <pre><code>cd lab-tgw-fgcp\ncp terraform.tfvars.example terraform.tfvars\n</code></pre></li> </ul> <p>Warning</p> <p>Modify the variable cidr_for_mgmt_access in the variable.tf or the terraform.tfvars. This restricts access to the FortiGate management interfaces. The default value is 0.0.0.0/0. The variable expects a comma seperated list of IP/CIDR.</p> <ul> <li>Initialise terraform <pre><code>terraform init\n</code></pre></li> <li>Confirm everything is ready to go <pre><code>terraform plan\n</code></pre></li> <li>If satisfied <pre><code>terraform apply\n</code></pre></li> </ul> <p>Tip</p> <p>Save the terraform output . You will be using these details through the lab.</p> <ul> <li> <p>Go to AWS Console and see what has been deployed in:  </p> <ul> <li>EC2<ul> <li>Instances</li> <li>Elastic IPs</li> <li>Security Groups</li> <li>Key Pairs</li> <li>Network Interfaces</li> </ul> </li> <li>VPC<ul> <li>VPCs</li> <li>Route Tables</li> <li>Internet Gateways</li> <li>Endpoint</li> <li>Transit Gateway (Attachment and Route Tables)</li> </ul> </li> </ul> </li> <li> <p>Log in to the FortiGate active management interface in a web browser and confirm the cluster is in Sync (this may take a few minutes) once the cluster is in sync begin Exercise 1</p> </li> </ul>"},{"location":"environment/","title":"Environment Overview","text":"<p>Please review the deployment and refer to this often throughout the lab as a reference source. All the relevant IP Information is present in the diagram below.</p> <p></p>"},{"location":"exercise-1/","title":"Exercise 1 - Ingress with SNAT","text":""},{"location":"exercise-1/#ingress-traffic-flow-from-jumpbox-to-workloada-with-snat-enabled-on-the-policy","title":"Ingress Traffic flow from Jumpbox to WorkloadA with SNAT enabled on the policy","text":"<p>Info</p> <p>The IP Address of the Ubuntu Host is 10.99.98.10</p> <p>Success Requirement</p> <ol> <li>From your device (not the Jumphost) SSH to Workload A using <code>ssh -P &lt;port&gt; -i sshkey-aplab-ssh-priv.pem ubuntu@&lt;clusterIP&gt;</code> Use the port forward you configured</li> <li>Run <code>ss -nat</code> on Workload A and confirm the source IP is the FortiGate. Look for ESTAB sessions</li> </ol> <p></p> <p>Warning</p> <p>Either use port translation or change the FortiGate SSH listening listening address on Port1. Port translaton is preferred.</p> <p>Danger</p> <p>Multiple failed login attempts to the FortiGate SSH CLI will result in a 5+ minute lockout. Any failed login should be carefully considered before attempting again. Ask yourself - Am I connecting to the FortiGate or to the Ubuntu host?</p> <p>Tip</p> <p>FortiGate offers powerful diagnostic tools. Try some of the following when connecting <code>diag sniffer packet any \u2018tcp and port 22\u2019 4 0 1</code> <code>diag sniffer packet any \u2018tcp and port 2222\u2019 4 0 1</code> - if using a tcp port translation <code>diag sniffer packet any \u2018host &lt;ip&gt;\u2019 4 0 1</code> - if you want to focus on a specific IP</p> Help I'm Lost! <ol> <li>Create a VIP</li> <li>Create a Policy</li> </ol>"},{"location":"exercise-2/","title":"Exercise 2 - Ingress (No SNAT)","text":""},{"location":"exercise-2/#ingress-traffic-flow-from-jumpbox-to-workloada-no-snat","title":"Ingress Traffic flow from Jumpbox to WorkloadA (no SNAT)","text":"<p>This is an extension of Exercise 1</p> <p>Info</p> <p>The IP Address of the Ubuntu Host is 10.99.98.10</p> <p>Success Requirement</p> <ol> <li>From your device (not the Jumphost) SSH to Workload A using <code>ssh -P &lt;port&gt; -i sshkey-aplab-ssh-priv.pem ubuntu@&lt;clusterIP&gt;</code> Use the port forward you configured</li> <li>Run <code>ss -nat</code> on Workload A and confirm the source IP is the FortiGate. Look for ESTAB sessions</li> </ol> <p></p> <p>Warning</p> <p>Either use port translation or change the FortiGate SSH listening listening address on Port1. Port translation is preferred</p> <p>Danger</p> <p>Multiple failed login attempts to the FortiGate SSH CLI will result in a 5+ minute lockout. AAny failed login should be carefully considered before attempting again. Ask yourself - Am I connecting to the FortiGate or to the Ubuntu host?</p> <p>Tip</p> <p>FortiGate offers powerful diagnostic tools. Try some of the following when connecting <code>diag sniffer packet any \u2018tcp and port 22\u2019 4 0 1</code> <code>diag sniffer packet any \u2018tcp and port 2222\u2019 4 0 1</code> - if using a tcp port translation <code>diag sniffer packet any \u2018host &lt;ip&gt;\u2019 4 0 1</code> - if you want to focus on a specific IP</p> Help I'm Lost! <ol> <li>Just policy?</li> </ol>"},{"location":"exercise-3/","title":"Exercise 3 - Egress","text":""},{"location":"exercise-3/#egress-traffic-to-the-internet-from-the-spoke-vpcs","title":"Egress traffic to the Internet from the Spoke VPCs","text":"<p>Success Requirement</p> <ol> <li>From Workload A - ping/curl/wget public services.</li> <li><code>ping 8.8.8.8</code> or <code>ping 1.1.1.1</code></li> <li><code>curl ipinfo.io</code> what IP do you see? You can also use <code>ssh sshmyip.com</code> </li> <li><code>ss -nat</code> on Workload A and confirm the source is the original source IP.</li> </ol> <p></p> <p>Tip</p> <p>FortiGate offers powerful diagnostic tools. Try some of the following when connecting <code>diag sniffer packet any \u2018icmp\u2019 4 0 1</code> <code>diag sniffer packet any \u2018tcp and port 443\u2019 4 0 1</code> <code>diag sniffer packet any \u2018host 1.1.1.1\u2019 4 0 1</code> - if you want to focus on a specific destination for a ping for example</p> Help I'm Lost! <ol> <li>Create a Policy? From where to where?</li> </ol>"},{"location":"exercise-4/","title":"Exercise 4 - East-West","text":""},{"location":"exercise-4/#egress-traffic-to-the-internet-from-the-spoke-vpcs","title":"Egress traffic to the Internet from the Spoke VPCs","text":"<p>IP Address Quick Reference</p> <ul> <li>The IP Address of the Workload A is 10.99.98.10</li> <li>The IP Address of the Workload B is 10.99.97.10</li> </ul> <p>Success Requirement</p> <ol> <li>From Workload A - Successfully ping Workload B</li> <li>From Workload A - Successfully SSH to Workload B </li> </ol> <p>Info</p> <p>SSH in AWS Requires SSH keys unless you do additional bootstrap activities to override this. SSH-Agent has not been enabled on Workload A and Workload B. To accommodate SSH from Workload A to Workload B you will need to get the key from the Jumphost to Workload A. While on the Jumphost: <pre><code>scp -i sshkey-aplab-ssh-priv.pem sshkey-aplab-ssh-priv.pem ubuntu@&lt;FGT Cluster IP&gt;:.\n</code></pre> If using a custom port (as you should) <pre><code>scp -P &lt;custom port&gt; -i sshkey-aplab-ssh-priv.pem sshkey-aplab-ssh-priv.pem ubuntu@&lt;FGT Cluster IP&gt;:.\n</code></pre> This will copy the SSH key to the home directory of Workload A and you can initiate the session from there.</p> <p>Note the . after the : - This is eseential. Don't forget the .</p> <p></p> <p>Tip</p> <p>FortiGate offers powerful diagnostic tools. Try some of the following when connecting <code>diag sniffer packet any \u2018icmp\u2019 4 0 1</code> <code>diag sniffer packet port2 \u2018tcp and port 2\u2019 4 0 1</code> <code>diag sniffer packet any \u2018host 10.99.98.10\u2019 4 0 1</code> - one of the spokes</p> Help I'm Lost! <ol> <li>Create a Policy?</li> <li>Make sure you use the key you copied to Workload A when you connect to Workload B</li> </ol>"},{"location":"exercise-5/","title":"Exercise 5 - High Availability","text":""},{"location":"exercise-5/#egress-traffic-to-the-internet-from-the-spoke-vpcs","title":"Egress traffic to the Internet from the Spoke VPCs","text":"<p>Success Requirement</p> <ol> <li>Confirm connectivity established in Exercise 1-4</li> <li>Monitor the failover mechanism</li> <li>See how our sessions behave during a failover.</li> </ol> <p></p> <p>To fully test HA we need to have multiple active sessions open when we begin the HA event. Specifically an ingress flow and an east-west flow. Ideally with a protocol that doesn't handle resumption and a protocol that is not session based. We ill be using:</p> <ul> <li>SSH for TCP non session aware protocol</li> <li>Ping for the non-session based protocol</li> </ul> <p>To achieve this we are going to use a Byobu a tmux/screen implementation available on Ubuntu that allows us to detach our session and resume the session later. This allows us to run things in the background while getting disconnected. </p> <ul> <li>From the Jumphost connect to Workload A</li> <li>Run <code>byobu</code><ul> <li>You will now be in a terminal session multiplexer</li> <li>User control-a to initiate an action in byobu. This will pull up a menu asking what mode you want to use. Select 1 </li> <li>control-a is a leader-key: You start the action with this then do the action with the next keypress. We wll be using control-a d to detach from a session once we have our flows running.</li> <li>From the Byobu session on Workload A establish a SSH Session to Workload B<ul> <li>While on Workload B run a ping to Workload A</li> </ul> </li> <li>Now control-a d to detach from the Byobu session</li> </ul> </li> <li>Everything is still running! The Byobu is still running you are just detached. As long as Workload A is still running you can always return to you Byobu session by running <code>byobu</code> again.</li> <li>Leave this SSH session open.</li> </ul> <p>Info</p> <p>In Byobu you can open a new terminal with control-a c and then control-a n, control-a space and control-a p to cycle between the new terminals (tabs)</p> <p>Now we are ready to initiate the failover and see what happens: - Connect to FortiGate A and FortiGate B on their management IP addresses - either through the graphical administration terminal or by SSH connection directly to the FortiGates from your workstation as no SSH key is required (provided you have set a password during your first login)</p> <p>Warning</p> <p>Do not connect to the FortiGates from the Jumphost for these steps</p> <ul> <li> <p>On the Passive FortiGate <pre><code>diag debug application awsd -1\ndiag debug enable\n</code></pre></p> </li> <li> <p>On the Active FortiGate <pre><code>exec ha failover set 1\n</code></pre> Monitor the output</p> </li> <li> <p>Reconnect to Workload A and re-attach to the your Byobu session.</p> </li> </ul> <p>Feel free to repeat the failover if you want to run more tests.</p> <p>HINT: If not your VIP is probably the problem \u2026 what is the solution though? \u201c show system vdom-exception?\u201d What are these Discussion \u2013 What sessions would survive a failover?</p> <p>Questions: So what happened</p> <ol> <li>What does the out on the Passive during the failover mean? Check AWS Console?</li> <li>What happened to you sessions and why? </li> <li>Which sessions survived?</li> <li>How many ping packets did you lose?</li> <li>What if it didn't work? (see the failure information below)</li> </ol> <p>FAIL \"I cant reconnect to  Workload A\"</p> <ol> <li>The EIP and Routes moved but still can't connect.<ul> <li>What is wrong with your VIP?</li> <li>Discussion - <code>config system vdom-exception</code> </li> </ul> </li> <li>The EIP and Routes didn't move!<ul> <li>Phone a friend - call the instructor.</li> </ul> </li> </ol> <p>Tip \"My SSH has locked my session</p> <p>If an SSH terminal is hanging due to a disconnection you can break out of this by using the following sequence: enter - enter - ~ - . enter enter - a 2nd enter just to make sure ~ - Tilde key . - Period</p>"}]}